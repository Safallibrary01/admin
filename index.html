<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safal Library - Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        
        .input-group label { font-size: 0.75rem; font-weight: 600; color: #64748b; margin-bottom: 0.25rem; display: block; }
        .input-field { width: 100%; padding: 0.75rem; border-radius: 0.75rem; border: 1px solid #e2e8f0; background: #f8fafc; font-size: 0.875rem; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        .hidden { display: none; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans pb-20">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white w-10 h-10 flex items-center justify-center rounded-xl shadow-blue-200 shadow-lg">
                    <i class="fa-solid fa-book-open"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-800 leading-tight">Safal Library</h1>
                    <p class="text-[10px] text-green-600 font-bold uppercase tracking-wide"><i class="fa-solid fa-circle text-[6px] mr-1"></i> Online Mode</p>
                </div>
            </div>
            <button onclick="toggleView('list')" class="relative p-2 text-slate-400 hover:text-blue-600 transition">
                <i class="fa-solid fa-users-gear text-xl"></i>
            </button>
        </div>
    </header>

    <main id="registrationView" class="max-w-md mx-auto px-4 py-6">
        <div class="flex justify-between items-end mb-4">
            <h2 class="text-xl font-bold text-slate-700">New Enrollment</h2>
            <button type="button" onclick="clearForm()" class="text-xs text-blue-600 font-medium">Reset Form</button>
        </div>

        <form id="enrollmentForm" class="space-y-4">
            <input type="hidden" id="editDocId" value=""> 

            <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100">
                <h3 class="text-xs font-bold text-blue-600 uppercase mb-3"><i class="fa-solid fa-id-card mr-1"></i> Library Account</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label>Registration No.</label>
                        <input type="text" id="regNo" placeholder="e.g. SL-101" class="input-field bg-white border-blue-200 text-blue-700 font-bold" required>
                    </div>
                    <div class="input-group">
                        <label>Date of Reg.</label>
                        <input type="date" id="regDate" class="input-field bg-white" required>
                    </div>
                </div>
                <div class="input-group">
                    <label>Set Password</label>
                    <input type="text" id="password" placeholder="Create login password" class="input-field bg-white">
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200/60">
                <div class="input-group mb-4">
                    <label>Student Name</label>
                    <input type="text" id="studentName" placeholder="Full Name" class="input-field" required>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label>Father's Name</label>
                        <input type="text" id="fatherName" placeholder="Mr. Name" class="input-field">
                    </div>
                    <div class="input-group">
                        <label>Mother's Name</label>
                        <input type="text" id="motherName" placeholder="Mrs. Name" class="input-field">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="input-group">
                        <label>Aadhar No.</label>
                        <input type="number" id="aadharNo" placeholder="1234 5678..." class="input-field">
                    </div>
                    <div class="input-group">
                        <label>Gender</label>
                        <select id="gender" class="input-field">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200/60">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label>Mobile No.</label>
                        <input type="tel" id="mobileNo" placeholder="Student No." class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label>Guardian No.</label>
                        <input type="tel" id="guardianNo" placeholder="(Optional)" class="input-field">
                    </div>
                </div>
                <div class="input-group">
                    <label>Address</label>
                    <textarea id="address" rows="2" placeholder="Full Address" class="input-field"></textarea>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200/60">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">Shift & Fees</h3>
                </div>
                
                <div class="flex items-center gap-2 mb-4">
                    <div class="input-group flex-1">
                        <label>Start Time</label>
                        <input type="time" id="startTime" class="input-field">
                    </div>
                    <span class="text-slate-400 mt-4">-</span>
                    <div class="input-group flex-1">
                        <label>End Time</label>
                        <input type="time" id="endTime" class="input-field">
                    </div>
                </div>

                <div class="input-group bg-red-50 p-3 rounded-xl border border-red-100">
                    <label class="text-red-600"><i class="fa-regular fa-calendar-xmark mr-1"></i> Next Fee Due Date</label>
                    <input type="date" id="feeDueDate" class="input-field bg-white border-red-200 text-red-600 font-semibold">
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200/60">
                <h3 class="text-xs font-bold text-orange-500 uppercase mb-3">Form Photo</h3>
                
                <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden" onchange="handleImageUpload(event)">
                
                <label for="cameraInput" id="uploadLabel" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition">
                    <i class="fa-solid fa-camera text-slate-300 text-2xl mb-2"></i>
                    <p class="text-xs text-slate-500">Tap to Capture</p>
                </label>

                <div id="previewArea" class="hidden relative mt-2 rounded-xl overflow-hidden border border-slate-200 bg-black">
                    <img id="imagePreview" class="w-full h-48 object-contain" src="">
                    <div class="absolute top-2 right-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-md" id="fileSize">0 MB</div>
                    <button type="button" onclick="resetImage()" class="absolute top-2 left-2 bg-red-500 text-white w-6 h-6 rounded-full text-xs flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <input type="hidden" id="compressedImageData">
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-check-circle"></i>
                <span id="submitBtnText">Submit Registration</span>
            </button>
        </form>
    </main>

    <main id="adminView" class="hidden max-w-md mx-auto px-4 py-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-slate-700">Student List</h2>
            <button onclick="toggleView('form')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-200">
                <i class="fa-solid fa-plus mr-1"></i> Add New
            </button>
        </div>

        <div class="relative mb-4">
            <i class="fa-solid fa-search absolute left-3 top-3.5 text-slate-400 text-sm"></i>
            <input type="text" id="searchInput" onkeyup="filterStudents()" placeholder="Search Name, Reg No, or Mobile..." class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 bg-white text-sm focus:outline-none focus:border-blue-500">
        </div>

        <div id="studentListContainer" class="space-y-3 pb-24">
            <div class="text-center py-10"><div class="loader"></div><p class="text-xs text-slate-400 mt-2">Loading Database...</p></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- 1. NEW API CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAEU3K8FzwfZOsdTHSOTBzPoQ7wWc1jIhk",
            authDomain: "safallibrary02-4e47b.firebaseapp.com",
            projectId: "safallibrary02-4e47b",
            storageBucket: "safallibrary02-4e47b.firebasestorage.app",
            messagingSenderId: "718136047267",
            appId: "1:718136047267:web:1ff63497bcb84d05323116"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global State
        let allStudents = [];
        
        // Init Defaults
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('regDate').value = today;
        const nextMonth = new Date();
        nextMonth.setDate(nextMonth.getDate() + 30);
        document.getElementById('feeDueDate').value = nextMonth.toISOString().split('T')[0];

        // --- 2. VIEW LOGIC ---
        window.toggleView = function(view) {
            const formView = document.getElementById('registrationView');
            const listView = document.getElementById('adminView');
            
            if(view === 'list') {
                formView.classList.add('hidden');
                listView.classList.remove('hidden');
                loadStudents(); // Load from Firebase
            } else {
                listView.classList.add('hidden');
                formView.classList.remove('hidden');
            }
        }

        // --- 3. IMAGE COMPRESSION ---
        window.handleImageUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    let width = img.width;
                    let height = img.height;
                    const maxDim = 1000; // Limit for Firestore

                    if (width > height) {
                        if (width > maxDim) { height *= maxDim / width; width = maxDim; }
                    } else {
                        if (height > maxDim) { width *= maxDim / height; height = maxDim; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    let quality = 0.8;
                    let dataUrl = canvas.toDataURL('image/jpeg', quality);
                    
                    document.getElementById('imagePreview').src = dataUrl;
                    document.getElementById('previewArea').classList.remove('hidden');
                    document.getElementById('uploadLabel').classList.add('hidden');
                    document.getElementById('compressedImageData').value = dataUrl;
                    
                    const sizeMB = (dataUrl.length * 3 / 4 / (1024*1024)).toFixed(2);
                    document.getElementById('fileSize').innerText = sizeMB + " MB";
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        window.resetImage = function() {
            document.getElementById('previewArea').classList.add('hidden');
            document.getElementById('uploadLabel').classList.remove('hidden');
            document.getElementById('compressedImageData').value = "";
            document.getElementById('cameraInput').value = "";
        }

        // --- 4. SUBMIT (SAVE TO FIREBASE) ---
        document.getElementById('enrollmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = document.getElementById('submitBtnText').innerText;
            
            document.getElementById('submitBtnText').innerText = "Saving to Cloud...";
            btn.disabled = true;

            try {
                const studentData = {
                    regNo: document.getElementById('regNo').value.toUpperCase(),
                    password: document.getElementById('password').value,
                    regDate: document.getElementById('regDate').value,
                    name: document.getElementById('studentName').value,
                    father: document.getElementById('fatherName').value,
                    mother: document.getElementById('motherName').value,
                    aadhar: document.getElementById('aadharNo').value,
                    gender: document.getElementById('gender').value,
                    mobile: document.getElementById('mobileNo').value,
                    guardianMobile: document.getElementById('guardianNo').value,
                    address: document.getElementById('address').value,
                    shiftStart: document.getElementById('startTime').value,
                    shiftEnd: document.getElementById('endTime').value,
                    feeDueDate: document.getElementById('feeDueDate').value,
                    image: document.getElementById('compressedImageData').value,
                    timestamp: new Date()
                };

                const editDocId = document.getElementById('editDocId').value;

                if (editDocId) {
                    // Update Existing
                    await updateDoc(doc(db, "students", editDocId), studentData);
                    alert('Student Updated Successfully!');
                } else {
                    // Create New
                    await addDoc(collection(db, "students"), studentData);
                    alert('Student Registered Successfully!');
                }

                clearForm();
                toggleView('list');

            } catch (error) {
                console.error("Error:", error);
                alert("Error saving data: " + error.message);
            } finally {
                document.getElementById('submitBtnText').innerText = originalText;
                btn.disabled = false;
            }
        });

        // --- 5. LOAD & RENDER LIST ---
        async function loadStudents() {
            const container = document.getElementById('studentListContainer');
            container.innerHTML = `<div class="text-center py-10"><div class="loader"></div><p class="text-xs text-slate-400 mt-2">Loading...</p></div>`;

            try {
                const querySnapshot = await getDocs(collection(db, "students"));
                allStudents = [];
                
                querySnapshot.forEach((doc) => {
                    allStudents.push({ id: doc.id, ...doc.data() });
                });

                renderList(allStudents);

            } catch (error) {
                container.innerHTML = `<p class="text-red-500 text-center">Error loading data. Check internet.</p>`;
            }
        }

        function renderList(list) {
            const container = document.getElementById('studentListContainer');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-400 py-10"><p>No students enrolled yet.</p></div>`;
                return;
            }

            // Sort newest first
            const sortedList = list.sort((a, b) => b.timestamp - a.timestamp);

            sortedList.forEach((s) => {
                // Fee Check
                const feeDate = new Date(s.feeDueDate);
                const todayDate = new Date();
                const isOverdue = feeDate < todayDate;
                const feeColor = isOverdue ? 'text-red-500 font-bold' : 'text-green-600';

                const avatarHTML = s.image 
                    ? `<img src="${s.image}" class="w-16 h-16 rounded-lg object-cover bg-slate-100 border border-slate-200">`
                    : `<div class="w-16 h-16 rounded-lg bg-blue-50 flex items-center justify-center text-blue-500 font-bold text-xl">${s.name.charAt(0)}</div>`;

                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex gap-3 relative overflow-hidden';
                
                card.innerHTML = `
                    ${avatarHTML}
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-slate-800 text-sm truncate">${s.name}</h3>
                            <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">#${s.regNo || '---'}</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-1"><i class="fa-solid fa-phone text-[10px] mr-1"></i> ${s.mobile}</p>
                        <div class="flex items-center gap-3 mt-2 text-[10px] text-slate-500 border-t border-slate-50 pt-2">
                             <span><i class="fa-solid fa-clock mr-1"></i>${formatTime(s.shiftStart)}-${formatTime(s.shiftEnd)}</span>
                             <span class="${feeColor}"><i class="fa-solid fa-indian-rupee-sign mr-1"></i>Due: ${s.feeDueDate || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 justify-center pl-2 border-l border-slate-50">
                        <button onclick="editStudent('${s.id}')" class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-600 hover:text-white transition">
                            <i class="fa-solid fa-pen text-xs"></i>
                        </button>
                        <button onclick="deleteStudent('${s.id}')" class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- 6. EDIT & DELETE ---
        window.editStudent = function(docId) {
            const s = allStudents.find(student => student.id === docId);
            if(!s) return;

            document.getElementById('editDocId').value = docId;
            
            // Populate Fields
            document.getElementById('regNo').value = s.regNo || '';
            document.getElementById('password').value = s.password || '';
            document.getElementById('regDate').value = s.regDate;
            document.getElementById('studentName').value = s.name;
            document.getElementById('fatherName').value = s.father;
            document.getElementById('motherName').value = s.mother;
            document.getElementById('aadharNo').value = s.aadhar;
            document.getElementById('gender').value = s.gender;
            document.getElementById('mobileNo').value = s.mobile;
            document.getElementById('guardianNo').value = s.guardianMobile;
            document.getElementById('address').value = s.address;
            document.getElementById('startTime').value = s.shiftStart;
            document.getElementById('endTime').value = s.shiftEnd;
            document.getElementById('feeDueDate').value = s.feeDueDate;
            
            if(s.image) {
                document.getElementById('imagePreview').src = s.image;
                document.getElementById('previewArea').classList.remove('hidden');
                document.getElementById('uploadLabel').classList.add('hidden');
                document.getElementById('compressedImageData').value = s.image;
            } else {
                resetImage();
            }

            document.getElementById('submitBtnText').innerText = "Update Student";
            toggleView('form');
        }

        window.deleteStudent = async function(docId) {
            if(confirm('Remove this student permanently from Database?')) {
                try {
                    await deleteDoc(doc(db, "students", docId));
                    loadStudents(); // Refresh List
                } catch(e) {
                    alert("Error deleting: " + e.message);
                }
            }
        }

        // --- 7. UTILS ---
        window.clearForm = function() {
            document.getElementById('enrollmentForm').reset();
            document.getElementById('editDocId').value = "";
            document.getElementById('regDate').valueAsDate = new Date();
            
            const nextMonth = new Date();
            nextMonth.setDate(nextMonth.getDate() + 30);
            document.getElementById('feeDueDate').value = nextMonth.toISOString().split('T')[0];

            document.getElementById('submitBtnText').innerText = "Submit Registration";
            resetImage();
        }

        window.filterStudents = function() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allStudents.filter(s => 
                s.name.toLowerCase().includes(term) || 
                (s.regNo && s.regNo.toLowerCase().includes(term)) || 
                s.mobile.includes(term)
            );
            renderList(filtered);
        }

        function formatTime(timeStr) {
            if(!timeStr) return "--";
            const [hour, min] = timeStr.split(':');
            const h = parseInt(hour);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${min}${ampm}`;
        }
    </script>
</body>
</html>